# Nix Flake Architecture Decisions

**Date:** 2025-11-26  
**For:** HC's questions on Nix setup

---

## Quick Answers

### Q1: Should project version be hardcoded in flake.nix?

❌ **NO** - Version should live in `pyproject.toml` only.

✅ **YES** - Nix reads version dynamically from `pyproject.toml`.

---

### Q2: Should Python packages be in Nix or in .venv?

✅ **Hybrid Approach:**
- Nix provides: Python interpreter + system tools
- `.venv` provides: Python packages (via pip)

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         flake.nix                               │
│                                                                 │
│  Single Source of Truth: pyproject.toml                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ projectMeta = fromTOML (readFile ./pyproject.toml)       │ │
│  │ version = projectMeta.project.version  # ← Dynamic       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Provides:                                                      │
│    ✅ Python 3.10 interpreter (version consistency)            │
│    ✅ System tools (git, docker-compose, just, jq)             │
│    ✅ Native libraries (openssl, libffi for C extensions)      │
│    ❌ NO Python packages (handled by pip)                      │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        .venv (pip)                              │
│                                                                 │
│  Created by: python -m venv .venv                               │
│  Populated by: pip install -e ".[dev]"                          │
│                                                                 │
│  Source of dependencies: pyproject.toml                         │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ [project]                                                 │ │
│  │ dependencies = ["fastapi>=0.122.0", ...]                  │ │
│  │                                                           │ │
│  │ [project.optional-dependencies]                           │ │
│  │ dev = ["pytest", "ruff", "mypy", ...]                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Contains:                                                      │
│    ✅ FastAPI, Uvicorn, Pydantic (runtime deps)                │
│    ✅ Pytest, Ruff, Mypy (dev deps)                            │
│    ✅ All PyPI packages from pyproject.toml                    │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   pyproject.toml                                │
│                   (SINGLE SOURCE OF TRUTH)                      │
│                                                                 │
│  [project]                                                      │
│  name = "mailreactor"                                           │
│  version = "0.1.0"          ← VERSION DEFINED HERE ONLY         │
│  dependencies = [...]       ← DEPENDENCIES DEFINED HERE ONLY    │
│                                                                 │
│  Both Nix and pip read from this file                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## Decision Matrix

| Aspect | Hardcode in Nix | Read from pyproject.toml | Verdict |
|--------|-----------------|-------------------------|---------|
| **Version** | ❌ Must sync manually | ✅ Single source of truth | **Use pyproject.toml** |
| **Python packages** | ❌ Duplicate list | ✅ pip install from project | **Use pyproject.toml** |
| **Python interpreter** | ✅ Version control | ❌ System-dependent | **Use Nix** |
| **System tools** | ✅ Reproducible | ❌ Not Python packages | **Use Nix** |

---

## What Goes Where

### pyproject.toml (Single Source of Truth)

```toml
[project]
name = "mailreactor"
version = "0.1.0"              # ← Version
dependencies = [               # ← Runtime deps
    "fastapi>=0.122.0",
    "uvicorn[standard]",
    "pydantic>=2.0",
]

[project.optional-dependencies]
dev = [                        # ← Dev deps
    "pytest>=7.4.0",
    "ruff>=0.1.0",
    "mypy>=1.7.0",
]
```

**Used by:**
- `pip install -e ".[dev]"` (installs packages)
- `nix build` (reads version)
- CI/CD (reads version and deps)

---

### flake.nix (Infrastructure Layer)

```nix
{
  # Read version from pyproject.toml (don't hardcode!)
  projectMeta = builtins.fromTOML (builtins.readFile ./pyproject.toml);
  version = projectMeta.project.version;
  
  devShells.default = pkgs.mkShell {
    buildInputs = [
      pkgs.python310        # ← Python interpreter
      pkgs.git              # ← System tools
      pkgs.docker-compose
      pkgs.just
      # NO Python packages here!
    ];
  };
}
```

**Provides:**
- Python interpreter (exact version)
- System-level tools
- Native libraries

**Does NOT provide:**
- Python packages (handled by pip)

---

## Workflow Examples

### Bumping Project Version

```bash
# 1. Edit pyproject.toml
[project]
version = "0.2.0"  # ← Change here ONLY

# 2. Everything updates automatically
nix build          # Uses 0.2.0
pip install -e .   # Uses 0.2.0
```

---

### Adding Python Dependency

```bash
# 1. Edit pyproject.toml
[project]
dependencies = [
    "fastapi>=0.122.0",
    "requests>=2.31.0",  # ← Add here
]

# 2. Install in venv
pip install -e ".[dev]"

# 3. Done! (Nix doesn't need updating)
```

---

### Adding System Tool

```bash
# 1. Edit flake.nix
buildInputs = [
    pkgs.python310,
    pkgs.git,
    pkgs.ripgrep,  # ← Add system tool here
]

# 2. Reload environment
direnv reload

# 3. Tool available
rg --version
```

---

## Benefits Summary

### ✅ This Hybrid Approach

**Pros:**
- Single source of truth for version and deps (pyproject.toml)
- Python version consistency (Nix)
- Fast package installation (pip with cache)
- Familiar Python workflow (pip, venv)
- All PyPI packages available
- Editable installs work naturally

**Cons:**
- Requires both Nix and pip knowledge
- Two-layer architecture (slightly more complex)

---

### ❌ Alternative: All in Nix

```nix
# NOT RECOMMENDED
pythonEnv = pkgs.python310.withPackages (ps: [
  ps.fastapi ps.uvicorn ps.pydantic  # ... 50+ packages
]);
```

**Pros:**
- Pure Nix (one tool)

**Cons:**
- ❌ Duplicate dependency list (pyproject.toml + flake.nix)
- ❌ Not all PyPI packages in Nixpkgs
- ❌ Nix package updates lag behind PyPI
- ❌ Harder editable installs
- ❌ Less familiar to Python developers

---

### ❌ Alternative: No Nix (Just venv)

```bash
# NOT RECOMMENDED
python3 -m venv .venv  # Which Python 3.x?
```

**Pros:**
- Familiar Python workflow

**Cons:**
- ❌ No Python version consistency
- ❌ "Works on my machine" problems
- ❌ CI/local version mismatches
- ❌ Manual system dependency management

---

## Implementation Checklist

For Sprint 0:

- [ ] Create `pyproject.toml` with version and dependencies
- [ ] Create `flake.nix` that reads from `pyproject.toml`
- [ ] Create `.envrc` for direnv auto-activation
- [ ] Test: Version bumping works (change pyproject.toml only)
- [ ] Test: Adding dep works (change pyproject.toml only)
- [ ] Test: Nix build uses correct version
- [ ] Document in `README.md`

---

## References

- `docs/development-practices.md` - Full Nix setup guide
- `pyproject.toml` - Project metadata (when created)
- `flake.nix` - Nix configuration (when created)

---

**Architecture approved by:** HC  
**Implementation:** Sprint 0 Task 6
