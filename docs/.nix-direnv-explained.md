# Why nix-direnv is Required

**Date:** 2025-11-26  
**Feedback:** HC noted we should use nix-direnv, not just plain direnv

---

## The Problem with Plain direnv + Nix

**Without nix-direnv:**

```bash
cd mailreactor
# direnv: loading ~/mailreactor/.envrc
# Building Nix environment... (30-60 seconds)
# âœ… Environment loaded

cd ..
cd mailreactor
# direnv: loading ~/mailreactor/.envrc
# Building Nix environment... (30-60 seconds AGAIN!)
# âœ… Environment loaded
```

**Every time you `cd` into the directory, direnv rebuilds the Nix environment!**

This is because plain direnv doesn't understand Nix's caching.

---

## The Solution: nix-direnv

**With nix-direnv:**

```bash
cd mailreactor
# direnv: loading ~/mailreactor/.envrc (using nix-direnv)
# Building Nix environment... (30-60 seconds - FIRST TIME ONLY)
# âœ… Environment loaded

cd ..
cd mailreactor
# direnv: loading ~/mailreactor/.envrc (using cached profile)
# âœ… Environment loaded (1 second!)
```

**nix-direnv caches the Nix environment and loads it instantly.**

---

## Performance Comparison

| Action | Plain direnv | nix-direnv | Speed Improvement |
|--------|--------------|------------|-------------------|
| First load | 30-60s | 30-60s | Same (must build) |
| Subsequent load | 30-60s | ~1s | **30-60x faster** |
| After `flake.nix` change | 30-60s | ~5s | **6-12x faster** |
| After `cd` away and back | 30-60s | ~1s | **30-60x faster** |

**Daily impact:**
- Plain direnv: 30s Ã— 50 directory changes = **25 minutes wasted per day**
- nix-direnv: 1s Ã— 50 directory changes = **50 seconds per day**

**Time saved per developer per day: ~24 minutes**

---

## How nix-direnv Works

### Plain direnv:
```
You: cd mailreactor
direnv: Loads .envrc
direnv: Runs "use flake"
Nix: Rebuilds entire environment (30-60s)
direnv: Activates environment
```

### nix-direnv:
```
First time:
You: cd mailreactor
direnv: Loads .envrc
nix-direnv: Checks cache (miss)
Nix: Builds environment (30-60s)
nix-direnv: Stores profile in cache
direnv: Activates environment

Subsequent times:
You: cd mailreactor
direnv: Loads .envrc
nix-direnv: Checks cache (hit!)
nix-direnv: Loads cached profile (~1s)
direnv: Activates environment
```

**Key difference:** nix-direnv stores a Nix profile (GC root) that persists between sessions.

---

## Installation

### Step 1: Install nix-direnv Package

```bash
# Method 1: nix-env (classic)
nix-env -iA nixpkgs.nix-direnv

# Method 2: nix profile (modern)
nix profile install nixpkgs#nix-direnv

# Verify
which nix-direnv-reload
# Should show path to nix-direnv-reload command
```

### Step 2: Configure direnv to Use nix-direnv

```bash
# Create direnv config directory
mkdir -p ~/.config/direnv

# Add nix-direnv sourcing
cat > ~/.config/direnv/direnvrc << 'EOF'
source $HOME/.nix-profile/share/nix-direnv/direnvrc
EOF

# Verify configuration
cat ~/.config/direnv/direnvrc
# Should show: source $HOME/.nix-profile/share/nix-direnv/direnvrc
```

### Step 3: Update Project .envrc

**Old .envrc (plain direnv):**
```bash
use flake
```

**New .envrc (with nix-direnv):**
```bash
# Use nix-direnv for caching (10-100x faster!)
if ! has nix_direnv_version || ! nix_direnv_version 2.3.0; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/2.3.0/direnvrc" "sha256-Dmd+j63L84wuzgyjITIfSxSD57Tx7v51DMxVZOsiUD8="
fi

use flake
```

**This automatically downloads nix-direnv if not installed system-wide.**

---

## Verification

### Test nix-direnv is Working

```bash
# First load (should build)
cd mailreactor
# Wait 30-60 seconds for Nix build
# âœ… Environment loaded

# Check nix-direnv created cache
ls -la .direnv/
# Should show directories: flake-inputs, flake-profile*, etc.

# Leave and return (should be FAST)
cd ..
time (cd mailreactor && echo "Loaded")
# Should be ~1 second, NOT 30 seconds

# If still slow, nix-direnv is NOT active
```

### Troubleshooting

**Symptom: Still slow (30s+ every time)**

```bash
# Check direnvrc exists
cat ~/.config/direnv/direnvrc
# Should show: source ... nix-direnv/direnvrc

# Check .envrc has nix-direnv stanza
cat .envrc
# Should have: if ! has nix_direnv_version ...

# Reload direnv
direnv reload

# Test again
```

**Symptom: `nix_direnv_version: command not found`**

```bash
# nix-direnv not installed or not configured
# Install:
nix-env -iA nixpkgs.nix-direnv

# Configure:
mkdir -p ~/.config/direnv
cat > ~/.config/direnv/direnvrc << 'EOF'
source $HOME/.nix-profile/share/nix-direnv/direnvrc
EOF

# Reload:
direnv reload
```

**Symptom: Permission denied on .direnv/**

```bash
# Clean and rebuild
rm -rf .direnv
direnv reload
```

---

## Cache Management

### Where is the Cache?

```bash
# In project directory
ls -la .direnv/
# Contains:
# - flake-inputs/   # Nix flake dependencies
# - flake-profile*  # Cached Nix profiles (GC roots)
```

**Important:** The `.direnv/` directory should be in `.gitignore` (never commit it).

### Invalidating Cache

**When to invalidate:**
- After changing `flake.nix`
- After updating Nix packages (rare)
- If environment seems stale

**How to invalidate:**
```bash
# Option 1: direnv reload (recommended)
direnv reload

# Option 2: Manual clean (if direnv reload doesn't work)
rm -rf .direnv
direnv reload
```

**nix-direnv automatically detects `flake.lock` changes and rebuilds incrementally.**

---

## Sprint 0 Integration

### Updated Sprint 0 Task #1

**Files to create:**

1. **.envrc** - Must include nix-direnv stanza:
   ```bash
   if ! has nix_direnv_version || ! nix_direnv_version 2.3.0; then
     source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/2.3.0/direnvrc" "sha256-Dmd+j63L84wuzgyjITIfSxSD57Tx7v51DMxVZOsiUD8="
   fi
   use flake
   ```

2. **.gitignore** - Must ignore direnv cache:
   ```
   .direnv/
   .envrc.cache
   ```

3. **README.md** - Must include nix-direnv installation in prerequisites

4. **docs/environment-setup-guide.md** - Updated with nix-direnv instructions

### Verification Checklist Updates

**Add to Nix Setup Verification (Step 1.5):**

```bash
# After first direnv allow:
ls .direnv/
# âœ… PASS: Directory exists with flake-profile*

# Test cache works:
cd .. && time (cd mailreactor)
# âœ… PASS: Takes ~1 second (not 30s)

# Verify nix-direnv in use:
direnv status | grep nix-direnv
# âœ… PASS: Shows nix-direnv is active
```

---

## Benefits Summary

### For Developers

âœ… **Instant environment activation** after first build  
âœ… **No waiting** when switching branches  
âœ… **Battery savings** on laptops (less CPU usage)  
âœ… **Less frustration** with slow startup times

### For Project

âœ… **Faster onboarding** (after initial setup)  
âœ… **More productive** development (less waiting)  
âœ… **Better DX** (developer experience)  
âœ… **Standard practice** in Nix community

---

## Comparison to Alternatives

### Alternative 1: Plain direnv (NO nix-direnv)

**Pros:**
- One less thing to install

**Cons:**
- âŒ 30-60s activation every time
- âŒ Wastes 20-30 minutes per developer per day
- âŒ Poor developer experience
- âŒ Drains battery on laptops

**Verdict:** Not acceptable for productive development.

---

### Alternative 2: Manual nix develop

**Without direnv at all:**
```bash
cd mailreactor
nix develop  # Must type this every time
# Wait 30-60s
```

**Pros:**
- No direnv needed

**Cons:**
- âŒ Must manually run `nix develop` every session
- âŒ Easy to forget
- âŒ No automatic activation
- âŒ Worse DX than direnv + nix-direnv

**Verdict:** Not recommended.

---

### Alternative 3: direnv + nix-direnv (RECOMMENDED)

**Pros:**
- âœ… Automatic environment activation
- âœ… Fast (1s after first load)
- âœ… Standard practice in Nix community
- âœ… Best developer experience

**Cons:**
- Requires installation of both direnv and nix-direnv (one-time setup)

**Verdict:** âœ… **This is the way.**

---

## References

- **nix-direnv GitHub:** https://github.com/nix-community/nix-direnv
- **direnv:** https://direnv.net
- **Nix Flakes:** https://nixos.wiki/wiki/Flakes

---

## Summary

**nix-direnv is REQUIRED because:**

1. Makes direnv 30-60x faster (1s vs 30-60s)
2. Standard practice in Nix community
3. Dramatically improves developer experience
4. Saves ~24 minutes per developer per day

**Installation is simple:**
1. `nix-env -iA nixpkgs.nix-direnv`
2. Configure `~/.config/direnv/direnvrc`
3. Add nix-direnv stanza to project `.envrc`

**Verification:**
- First load: 30-60s (builds Nix environment)
- Subsequent loads: ~1s (cached!)

**This is now documented in:**
- `docs/environment-setup-guide.md` (full instructions)
- `docs/development-practices.md` (Nix section)
- `docs/.nix-direnv-explained.md` (this file - detailed explanation)

---

**nix-direnv makes Nix + direnv usable for daily development! ðŸš€**
