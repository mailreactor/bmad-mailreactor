<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8</storyId>
    <title>Development Mode with Hot Reload</title>
    <status>drafted</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/hcvst/dev/bmad/bmad-mailreactor/docs/sprint-artifacts/1-8-development-mode-with-hot-reload.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>a `mailreactor dev` command that enables auto-reload during development</iWant>
    <soThat>I can iterate quickly without manually restarting the server</soThat>
    <tasks>
- [ ] Add `dev()` command to `cli/server.py` (AC: new command with same options)
  - [ ] Copy `start()` command structure (reuse same option definitions)
  - [ ] Set `reload=True` for Uvicorn configuration
  - [ ] Set `reload_dirs=["src/mailreactor"]` to watch only source code
  - [ ] Default log level to DEBUG (override Settings.log_level)
  - [ ] Disable JSON logs by default (console renderer for better DX)
  - [ ] Add development mode warning to startup logs
  - [ ] Log reload configuration: `auto_reload=True`, `watch_dir=src/mailreactor`

- [ ] Configure Uvicorn reload mode correctly (AC: watches file changes, reloads automatically)
  - [ ] Set `reload=True` in Uvicorn.run() call
  - [ ] Set `reload_dirs=["src/mailreactor"]` to limit watch scope
  - [ ] Use `reload_delay=0.5` for responsiveness (half-second after last change)
  - [ ] Exclude test directories (only watch source code)
  - [ ] Verify .pyc and __pycache__ changes don't trigger reload

- [ ] Add reload event logging (AC: logs each reload with file that changed)
  - [ ] Subscribe to Uvicorn reload events (if possible)
  - [ ] Log file change events: "[INFO]  Reloading due to file change file={path}"
  - [ ] If Uvicorn doesn't expose events, log basic reload message
  - [ ] Include timestamp in reload logs for tracking iterations

- [ ] Update __main__.py to register dev command (AC: `mailreactor dev` invocation works)
  - [ ] Add `dev()` to Typer app commands (already has `start()`)
  - [ ] Verify both `mailreactor dev` and `python -m mailreactor dev` work
  - [ ] Ensure command appears in `mailreactor --help` output
  - [ ] Add short help text: "Start with auto-reload for development"

- [ ] Write integration test for dev command (AC: command starts with reload enabled)
  - [ ] Test `mailreactor dev` starts server successfully
  - [ ] Test log output includes "Development mode enabled" message
  - [ ] Test log level defaults to DEBUG (not INFO)
  - [ ] Test --host and --port options work in dev mode
  - [ ] Test graceful shutdown works (Ctrl+C)
  - [ ] Note: File change reload not tested (requires filesystem events, complex)

- [ ] Update development practices documentation (AC: dev workflow documented)
  - [ ] Add "Development Mode" section to development-practices.md
  - [ ] Document difference between `start` (production) and `dev` (development)
  - [ ] Note that `dev` mode watches for file changes and auto-reloads
  - [ ] Warn against using `dev` mode in production (no performance optimization)
  - [ ] Example: `mailreactor dev` for quick iteration vs `mailreactor start` for deployment
</tasks>
  </story>

  <acceptanceCriteria>
**Given** the CLI from Story 1.4  
**When** adding development mode  
**Then** `src/mailreactor/cli/server.py` provides:
- `dev()` command using Typer
- Same options as `start` command (--host, --port, --log-level, --json-logs)
- Starts Uvicorn with `reload=True` (watches for file changes)
- Watches `src/mailreactor/` directory for changes
- Log level defaults to DEBUG in dev mode

**And** Running `mailreactor dev`:
- Displays "[INFO]  Development mode enabled auto_reload=True watch_dir=src/mailreactor"
- Reloads application automatically when Python files change
- Logs each reload event with changed file: "[INFO]  Reloading due to file change file=main.py"
- Uses colored console logging by default (not JSON, better DX)
- Can enable JSON logs with `--json-logs` flag if needed

**And** Development mode warning displayed: "[WARN]  Development mode active (not for production use)"

**And** Console output shows reload events:
```
[INFO]  Development mode enabled auto_reload=True watch_dir=src/mailreactor
[INFO]  Mail Reactor started url=http://127.0.0.1:8000
[INFO]  API documentation available url=http://127.0.0.1:8000/docs
[WARN]  Development mode active (not for production use)
...user edits file...
[INFO]  Reloading due to file change file=main.py
[INFO]  Mail Reactor started url=http://127.0.0.1:8000
```

**Prerequisites:** Story 1.4 (CLI with start command)
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Mail Reactor Architecture</title>
        <section>Development Setup / CLI Framework / Project Structure</section>
        <snippet>Development mode (`mailreactor dev`) uses Uvicorn with `reload=True` to watch for file changes. Typer CLI provides `start` (production) and `dev` (development) commands. Log level defaults to DEBUG in dev mode for detailed troubleshooting.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Zero-Config Deployment</title>
        <section>Story 1.8: Development Mode with Hot Reload</section>
        <snippet>Implements `dev()` command using Typer with same options as `start` (--host, --port, --log-level). Uvicorn reload mode watches `src/mailreactor/` for file changes with `reload=True` and `reload_dirs` configuration.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 1: Foundation & Zero-Config Deployment</title>
        <section>Story 1.8: Development Mode with Hot Reload</section>
        <snippet>Adds auto-reload capability for rapid iteration. Developer can edit source files and see changes immediately without manual server restart. Console logging preferred over JSON for better developer experience.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>mailreactor/src/mailreactor/cli/server.py</path>
        <kind>cli_command</kind>
        <symbol>start()</symbol>
        <lines>27-119</lines>
        <reason>Existing start command to replicate pattern for dev command. Uses Typer options, configure_logging(), creates FastAPI app, runs uvicorn with reload=False. Dev command will mirror this with reload=True.</reason>
      </file>
      <file>
        <path>mailreactor/src/mailreactor/__main__.py</path>
        <kind>cli_entry</kind>
        <symbol>dev()</symbol>
        <lines>60-66</lines>
        <reason>Dev command stub already exists (not implemented). Need to remove stub and register actual server.dev function like start command (line 57).</reason>
      </file>
      <file>
        <path>mailreactor/src/mailreactor/utils/logging.py</path>
        <kind>utility</kind>
        <symbol>configure_logging()</symbol>
        <lines>62-128</lines>
        <reason>Logging configuration function used by both start and dev commands. Accepts json_format and log_level parameters. Dev command will call this with json_format=False (default) and log_level='DEBUG'.</reason>
      </file>
      <file>
        <path>mailreactor/src/mailreactor/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>N/A</lines>
        <reason>Pydantic Settings model for application configuration. Start command creates Settings instance with CLI args. Dev command will do same.</reason>
      </file>
      <file>
        <path>mailreactor/src/mailreactor/main.py</path>
        <kind>application</kind>
        <symbol>create_app()</symbol>
        <lines>N/A</lines>
        <reason>FastAPI application factory. Both start and dev commands call this to create app instance before passing to uvicorn.run().</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="uvicorn" version="[standard]" usage="ASGI server with reload capability (reload=True, reload_dirs, reload_delay parameters)" />
        <package name="typer" version=">=0.20.0" usage="CLI framework for dev command with Options and decorators" />
        <package name="structlog" version="latest" usage="Structured logging (logger.info, logger.warning)" />
        <package name="fastapi" version=">=0.122.0" usage="Web framework (app created by create_app())" />
        <package name="pydantic-settings" version="latest" usage="Settings model for configuration" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Testing Principle: Only test functionality WE have added. Do not test Uvicorn's file watching or Python machinery. Test that dev command exists, accepts correct arguments, and logs development mode enabled.</constraint>
    <constraint>Project Structure: Modified file is mailreactor/src/mailreactor/cli/server.py (add dev function). Update mailreactor/src/mailreactor/__main__.py (replace stub registration).</constraint>
    <constraint>Code Style: Keep code focused and sharp. Consult 3rd party docs (Uvicorn, Typer) for canonical usage patterns. Reuse existing start() command structure.</constraint>
    <constraint>Development Pattern: dev command should mirror start command but override: reload=True, reload_dirs=["src/mailreactor"], reload_delay=0.5, default log_level="DEBUG".</constraint>
    <constraint>Logging: Use structlog logger (already imported in server.py). Warning level for "Development mode active (not for production use)". Info level for "Development mode enabled" with auto_reload=True.</constraint>
    <constraint>CLI Framework: Use Typer decorators and options exactly like start command. Help text should be clear and concise.</constraint>
    <constraint>No Git Operations: HC handles all commits. Do not commit changes.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>dev() CLI command</name>
      <kind>Typer command function</kind>
      <signature>def dev(host: str = typer.Option("127.0.0.1", ...), port: int = typer.Option(8000, ...), log_level: str = typer.Option("DEBUG", ...), json_logs: bool = typer.Option(False, "--json-logs", ...)) -> None</signature>
      <path>mailreactor/src/mailreactor/cli/server.py</path>
    </interface>
    <interface>
      <name>uvicorn.run() with reload</name>
      <kind>ASGI server invocation</kind>
      <signature>uvicorn.run(app, host=str, port=int, reload=bool, reload_dirs=list[str], reload_delay=float, log_level=str, access_log=bool, log_config=None)</signature>
      <path>External: uvicorn package</path>
    </interface>
    <interface>
      <name>configure_logging()</name>
      <kind>Utility function</kind>
      <signature>def configure_logging(json_format: bool = False, log_level: str = "INFO") -> None</signature>
      <path>mailreactor/src/mailreactor/utils/logging.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Mail Reactor uses pytest with Red-Green-Refactor TDD workflow (mandatory). Test ONLY functionality WE add - not Python machinery, not 3rd party libraries. Framework: pytest + pytest-asyncio. Pattern: Unit tests in tests/unit/, integration tests in tests/integration/. Fixture location: tests/conftest.py. Test naming: test_{module}_{function}__{scenario}.py. Coverage: Focus on value-add code, not framework glue.</standards>
    <locations>
      <location>mailreactor/tests/unit/</location>
      <location>mailreactor/tests/integration/</location>
      <location>mailreactor/tests/conftest.py</location>
    </locations>
    <ideas>
      <test_idea ac_ref="AC: dev() command using Typer">
        <description>Unit test: dev function exists with correct Typer signature (host, port, log_level, json_logs options)</description>
        <approach>Import server.dev, use inspect.signature() to verify parameters exist</approach>
        <file>tests/unit/test_cli_server.py</file>
      </test_idea>
      <test_idea ac_ref="AC: Log level defaults to DEBUG">
        <description>Unit test: dev command default log_level parameter is "DEBUG" not "INFO"</description>
        <approach>Check typer.Option default value in function signature</approach>
        <file>tests/unit/test_cli_server.py</file>
      </test_idea>
      <test_idea ac_ref="AC: Development mode warning displayed">
        <description>Integration test: Calling dev() logs warning message "Development mode active (not for production use)"</description>
        <approach>Mock uvicorn.run, capture structlog output, assert warning logged</approach>
        <file>tests/integration/test_dev_command.py</file>
      </test_idea>
      <test_idea ac_ref="AC: Displays development mode enabled message">
        <description>Integration test: dev() logs info message "Development mode enabled" with auto_reload=True context</description>
        <approach>Mock uvicorn.run, capture structlog output, verify message and context</approach>
        <file>tests/integration/test_dev_command.py</file>
      </test_idea>
      <test_idea ac_ref="AC: __main__.py registers dev command">
        <description>Unit test: Typer app has dev command registered (not stub)</description>
        <approach>Import app from __main__, check app.registered_commands includes "dev" pointing to server.dev</approach>
        <file>tests/unit/test_main.py</file>
      </test_idea>
      <test_idea ac_ref="Note: File watching not tested">
        <description>DO NOT test: Uvicorn file watching, actual reload on file change, filesystem events</description>
        <approach>These are Uvicorn's responsibility. We test OUR code only (command structure, logging, config).</approach>
        <file>N/A - explicitly excluded per team standards</file>
      </test_idea>
    </ideas>
  </tests>
</story-context>
